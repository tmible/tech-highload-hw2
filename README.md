# tech-highload-hw2
## Тема
Приложение для групповых видеозвонков.
Пользователь может:  
- войти, зарегистрироваться
- начать, закончить видеозвонок
- просоединиться к видеозвонку, покинуть его
## Нагрузка
В феврале 2020 года количество активных пользователей за месяц в zoom составило 12,92 млн [1].  
В апреле 2020 года пиковое количество участников видеозвонков в день составило 300+ млн [2].

Отмасштабировав эти значения на Россию, получим примерно 414 845 активных пользователей за месяц и 9 647 577 — пиковое количество участников видеозвонков в день.
1. https://www.cnbc.com/2020/02/26/zoom-has-added-more-users-so-far-this-year-than-in-2019-bernstein.html
2. https://blog.zoom.us/90-day-security-plan-progress-report-april-22/
## Логическая схема базы данных
Нужно хранить сессии авторизации, данные о пользователях, данные об активных звонках.

Пользователи
| Название | Тип         | Размер  |
| -------- | ----------- | ------- |
| id       | serial      | 4 байта |
| логин    | varchar(20) | 20 байт |
| пароль   | varchar(30) | 30 байт |
| email    | varchar(30) | 30 байт |
| имя      | varchar(30) | 30 байт |

Звонки
| Название  | Тип        | Размер          |
| --------- | ---------- | --------------- |
| id        | uuid       | 16 байт         |
| участники | array[int] | 8 байт — ∞ байт |
## Физическая система хранения
Сессии авторизации храним в Redis.

Данные о пользователях в Postgres: они в основном для чтения.

Данные об активных звонках в Tarantool: их нужно быстро создавать, быстро удалять, быстро выдавать, и живут они недолго.
## Прочие технологии
Бэкенд на Go. Состоит из двух независимых частей: сервиса авторизации и сервиса звонков. Протокол общения между фронтендом и сервисом авторизации — http.

Для обеспечения нормального общения большого количества (> 4) человек задействуем сервер-хост. Общение с ним происходит по протоколу UDP. Сервер будет принимать видео и аудио от каждого участника. Далее есть две опции: если участник сейчас в состоянии принять HD видео и аудио, ему отправляются необработанные буферы всех участников; если же не в состоянии, то сервер раскодирует принятые буферы, скомпонует их, закодирует в SD и отправит. 
## Расчет нагрузки и потребного оборудования
### Объём данных
Одна запись пользователя занимает 114 байт. Будем считать, что пользователей в базе 829 690. Итого 90 Мб данных о пользователях.

Нагрузка на Tarantool составит 1 вставку, 1 удаление и в среднем 40 подключений и 20 отключений для 241 190 звонков в день.
### RPS
В идеале мы транслируем аудио и видео в Full HD 60 fps для 30 000 клиентов в течение часа. То есть это 1 800 000 rps. С учётом авторизаций, подлючений, отлючений, создания и удаления звонков — __ .
### Оборудование
На каждого участника звонка выделяется два потока: один для аудио, один для видео. Также на каждый звонок основной поток и поток-кодировщик для контроля качетсва видео. Получется, нужно иметь около 60 005 потоков в каждый момент времени.
Оперативная память используется Redis, Tarantool и в качестве буфера для транслируемых видео и аудио. Суммарный объём в каждый момент времени — 21 байт (видео в full HD) * 30 000 + 5 * (16 байт + 40 * 8 байт) = 631 680 байт
## Выбор хостинга / облачного провайдера и расположения серверов *
Сервера располагаем по плотности населения.
## Схема балансировки нагрузки
Балансировку отдаём nginx. Логичнее всего по географическому принципу.
## Обеспечение отказоустойчивости
- понижение качества для видео
- понижение fps для демонстрации экрана
- ограничение количества участников звонка
- резервные сервера для пиковой нагрузки (потому что понижение качества увеличит нагрузку на процессор и память)
