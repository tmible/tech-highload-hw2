# tech-highload-hw2
## Тема
Приложение для групповых видеозвонков.
Пользователь может:  
- войти, зарегистрироваться
- начать, закончить видеозвонок
- просоединиться к видеозвонку, покинуть его
## Нагрузка
Будем исходить из того, что в сервисе максимально 2 411 895 активных пользователей в день и 9 647 577 участников видеозвонков в день. То есть каждый пользователь поучаствовал в среднем в 4 звонках. Будем считать, что звонок в среднем идёт 1 час и имеет 40 участников. Получаем в сутки примерно 241 189 звонков. С учётом распределения суточной нагрузки — 16 817 одновременно идущих звонков максимально.
## Логическая схема базы данных
Нужно хранить сессии авторизации, данные о пользователях, данные об активных звонках.

Сессия
| Название | Тип  | Размер  |
| -------- | ---- | ------- |
| sessinID | uuid | 16 байт |
| userID   | int  | 8 байт  |

Пользователи
| Название | Тип         | Размер  |
| -------- | ----------- | ------- |
| id       | int         | 8 байт  |
| логин    | string      | 20 байт |
| пароль   | string      | 30 байт |
| email    | string      | 30 байт |
| имя      | string      | 30 байт |

Звонки
| Название  | Тип        | Размер          |
| --------- | ---------- | --------------- |
| id        | uuid       | 16 байт         |
| участники | array[int] | 8 байт — ∞ байт |
## Физическая система хранения
### СУБД
Все данные храним в Tarantool.

Для сессии авторизации Tarantool подходит, потому что он быстрее Redis. [\[1\]][1] [\[2\]][2] [\[3\]][3]

Для холодных данные о пользователях используем Vinyl — движок Tarantool для хранения данных на диске. [\[4\]][4] [\[5\]][5]

Данные об активных звонках нужно быстро создавать, быстро удалять, быстро выдавать, и живут они недолго. Однозначно Tarantool.
### Расчёт нагрузки
Если считать, что пользователь разлогинивается после каждого звонка и заходит в приложение только ради них, получается средняя нагрузка на хранилище сессий — 111 RPS, пиковая — 1601 RPS.

Пусть пользователи авторизуются в половине случаев открытия приложения. Тогда данные о пользователе нужны при каждой проверке пароля и при каждом входе в звонок. Итого в среднем 167 RPS, максимально — 2402 RPS.

Для одного звонка в среднем требуется 62 операции: создание звонка, 40 присоединений к нему, 20 отсоединений, удаление звонка. Отсюда на хранилище звонков средняя нагрузка — 173 RPS, максимальная — 2482 RPS.

Для Tarantool это не нагрузка.
## Прочие технологии
Бэкенд на Go. Состоит из двух независимых частей: сервиса авторизации и сервиса звонков. Сервис звонков разбит на три микросервиса: микросервис загрузки видео/аудио, микросервис перекодировки видео, микросервис раздачи видео/аудио. Протокол общения между фронтендом и сервисом авторизации — HTTP.

Для обеспечения нормального общения большого количества (> 4) человек задействуем сервер-хост. Общение с ним происходит по протоколу UDP. Сервер будет принимать видео и аудио от каждого участника. Далее есть две опции: если участник сейчас в состоянии принять HD видео и аудио, ему отправляются необработанные буферы всех участников; если же не в состоянии, то сервер раскодирует принятые буферы, перекодирует в SD и отправит.

Также для оптимизации использования сети можно не получать и/или не отдавать звук, если он ниже определённого порога или если микрофон выключен; отдавать видео в качестве пропорциональном размеру его картинки на экране, т.е. если видео пользователя развёрнуто на весь экран (например, он сейчас говорит) отдаём его по логике из предыдущего абзаца, если же пользователь показан небольшим окошком в списке участников, понижаем качество его видео.

Для аудио будем использовать кодек Opus: он универсален в плане вида аудио (моно/стерео и т.п.) и имеет хорошее отношение качество/степень сжатия. Что наиболее важно: Opus имеет минимальную задержку при кодировании — от 2,5 мс до 60 мс. [\[6\]][6]  
Для видео — H.264. Он быстрее конкурентов, поддерживается на 99% устройств, менее требователен к батарее, имеет лучшее качество видео после кодирования и раскодирования и, что немаловажно, очень высокую степень сжатия. [\[7\]][7] [\[8\]][8]
## Расчет нагрузки и потребного оборудования
### Объём данных
Одна запись пользователя занимает 118 байт. Будем считать, что пользователей в базе 7 074 225. Итого 796 Мбайт данных о пользователях.

Суммарный объём хранилища сессий за сутки: `9 647 577 × 0,5 (другая половина сессий протухла) × 24 байт = 110 Мб`. Максимальный: `16 817 × 40 × 2,5 × 24 байт = 38,5 Мбайт`.

Суммарный объём хранилища звонков за сутки: `241 189 × (16 байт + 40 × 8 байт) = 77 Мбайт`. Максимальный — `5 Мбайт`.
### RPS
Для получения и передачи видео и аудио 9 647 577 человек в сутки сервис принимает в среднем `4466 RPS`. Максимально — `62 524 RPS`.  
Авторизации, подлючения к звонкам, отлючения от звонков, создание и удаление звонков создают ещё `55 + 167 = 222 RPS` в среднем, `3190 RPS` максимально.
### Трафик
#### Видео
Будем считать, что каждый человек в среднем использует видео 60% времени, проводимого в звонках.  
Для получения видео от 9 647 577 участников звонков (по часу и по 40 человек в среднем) потребуется `b × 3600 с × 9 647 577 × 0,6` трафика в сутки  
Для передачи видео 9 647 577 участников звонков остальным участникам звонка (по часу и по 40 человек в среднем) потребуется `b × 3600 с × 9 647 577 × 0,6 × 39` трафика в сутки  
Где `b` — битрейт видео.

Битрейт видео, закодированного в H.264 (глубина цвета — 3 байта) [\[9\]][9]
|             | 24 fps         | 60 fps         |
| ----------- | -------------- | -------------- |
| 320 × 240   | 169,62 Кбайт/с | 424,05 Кбайт/с |
| 426 × 240   | 225,81 Кбайт/с | 564,52 Кбайт/с |
| 640 × 360   | 508,86 Кбайт/с | 1,27 Мбайт/с   |
| 854 × 480   | 905,34 Кбайт/с | 2,26 Мбайт/с   |
| 1280 × 720  | 2,04 Мбайт/с   | 5,09 Мбайт/с   |
| 1920 × 1080 | 4,58 Мбайт/с   | 11,45 Мбайт/с  |

То есть в идеале (1920×1080@60) получаем `8888 Пбайт` трафика в сутки. `105 Тбайт/c` в среднем, `1510 Тбайт/с` максмально.  
Фактически идеал недостижим и самым распространённым разрешением веб-камеры являяется VGA 640×480 с 4-битным цветом [\[10\]][10]. За среденее разрешение фронтальной камеры смартфона возьмём 1920×1080. Будем считать количество запросов с десктопов и смартфонов равными. Частоту кадров и для тех, и для тех примем 24 fps. Тогда получаем `42 Пбайт + 1777 Пбайт = 1819 Пбайт` трафика в сутки. `21,5 Тбайт/с` в среднем, `309 Тбайт/с` максимально.
Также учтём оптимизацию, понижающую качество видео пропорционально размеру на экране. Допустим, есть один говорящий + ещё 4 в списке участников. Тогда получаем `2784 Тбайт + 22 040 Тбайт = 24 824 Тбайт` трафика в сутки. `294 Гбайт/с (33,4|260,6)` в среднем, `4219,5 Гбайт/с (479,5|3740)` максимально. (Однако эта оптимизация увеличивает нагрузку на CPU, заставляя его перекодировать видео)
#### Аудио
Будем считать, что каждый человек в среднем использует аудио 10% времени, проводимого в звонках.  
Для получения аудио от 9 647 577 участников звонков (по часу и по 40 человек в среднем) потребуется `b × 3600 с × 9 647 577 × 0,1` трафика в сутки  
Для передачи аудио 9 647 577 участников звонков остальным участникам звонка (по часу и по 40 человек в среднем) потребуется `b × 3600 с × 9 647 577 × 0,1 × 39` трафика в сутки  
Где `b` — битрейт аудио.

Битрейт аудио, закодированного в Opus [\[11\]][11]
| узкополосное кодирование | широкополосное кодирование | полное кодирование | полное кодирование стерео |
| ------------------------ | -------------------------- | ------------------ | ------------------------- |
| 10 Кбит/с                | 16 Кбит/с                  | 40 Кбит/с          | 128 Кбит/с                |

То есть в идеале (128 Кбит/с) получаем 2070 Тбайт трафика в сутки, `24,5 Гбайт/c` в среднем, `352,3 Гбайт/с` максмально.
Фактически, скорее всего, в основном будет доступно и достаточно широкополосное кодирование (16 Кбит/с). `258 Тбайт` трафика в сутки. `3 Гбайт/c (0,28|2,72)` в среднем, `44 Гбайт/с (4,09|39,9)` максмально.
#### Остальное
Если взять 512 Кбайт за средний размер HTTP запроса, получим `222 RPS × 512 Кбайт × 2 = 222 Мбайт/c (111|111)` в среднем, `3190 RPS × 512 Кбайт × 2 = 3,1 Гбайт/с (1,55|1,55)` максимум.
#### Итого
`294 Гбайт/c + 3 Гбайт/c + 222 Мбайт/с = 297,2 Гбайт/с (33,78|263,43)` в среднем.  
`4219,5 Гбвйт/с + 44 Гбайт/с + 3,1 Гбайт/с = 4266,6 Гбайт/с (485,14|3781,45)` максимум.
### CPU
#### Кодировка видео
По данным [бенчмарка x264][benchmark] медианное количество кадров в секунду, обрабатываемых про кодировке видео 1920×1080 в H.264, составляет 75, среднее — 139, максимальное — 217. Получается, на среднем процессоре при хорошей конфигурации системы кодировкака одной секунды видео 1920×1080@60 займёт 0,43 с, на лучшем при хорошей конфигурации системы — 0,27 с. Кодировать нужно в основном 320×240@24, иногда 854×480@24. Отмасштабировав значения для 1 секунды 320×240@24, получим 6,4 мс и 4,01 мс на среднем и лучшем процессоре соответственно.

Стоит отметить, что по данным бенчмарка сложно судить о производительности кодировки на одном потоке того или иного процессора, так как неизвестно, как распределялась нагрузка между ними и не редки случаи, когда процессоры с меньшим количеством потоков обходят процессоры с большим, однако в топ-10 всего 2 процессора с 64 потоками, 2 с 192, остальные имеют 96-128. Поскольку кодировка/декодировка видео может стать узким местом, логично использовать 3 слоя серверов в обработке звонка по 3 микросервисам сервиса звонков: сервера, принимающие из сети аудио и видео, сервера, занимающиеся исключительно перекодировкой видео, и сервера, отправляющие аудио и видео в сеть. Для экономии внутреннего трафика целесообразно разворачивать микросервисы приёма и отправки на одной физической машине. При таком распределении потери ресурсов будут минимальными: помимо экономии трафика, экономится оперативная память: вместо 2 загрузок (одна извне + одна между микросервисами) и 2 выгрузок (одна вовне + одна между микросервисами) буферов происходят только по одной необходимой (загрузка извне и отправка вовне), а процессор сервера, занимающегося перекодировкой видео, может занимать все имеющиеся потоки, тем самым уменьшая задежрку в звонке. Но если всё-таки перекодировщику хватит 70-80% имеющихся потоков, я думаю, можно воплотить более компактное решение и при относительно небольшом количестве участников разговора (пока перекодировка не станет узким местом) разворачивать все 3 микросервиса, так сказать, кластером на одной машине. Это решение должно здорово уменьшить задержку в звонке, в силу превосходства скорости оперативной памяти над сетью.
#### Декодировка видео
Декодировка обходится гораздо дешевле. Так, даже на процессоре 2011 года она имеет скорость примерно 100 fps для файла с битрейтом 6500 Кбит/c. А запуск на 4 потоках даёт трёхкратный прирост скорости. [\[12\]][12]
#### Потоки
На каждого пользователя в звонке нужно иметь максимум 4 потока: 2 на приём и 2 на передачу. Плюс, наверное, 4,35x² потока кодировки и 1x поток декодировки. Плюс 2 основных потока: по одному на каждый микросервис. Итого для максимальной нагрузки (учтём, что не каждый говорит и показывает, а отдельный поток запускается только в случае необходимости приёма буферов этого пользователя) нужно иметь суммарно `151 353 + 1 345 360 + 33 634 + 67 268 × (4,35x² + x) = 1 530 347 + 269 072x² + 67 268x` потоков `(1 866 687 при х = 1)`. В пересчёте не один звонок — `89 + 2 + 16x² + 4x` потоков `(111 при х = 1)`.
### Оперативная память
В оперативной памяти нужно хранить `294 Гбайт видео + 3 Гбайт аудио = 297 Гбайт` по средней нагрузке и `4219,5 Гбайт видео + 44 Гбайт аудио = 4263,5 Гбайт` по максимальной нагрузке суммарно. В пересчёте на один звонок — `1,2 Мбайт` по средней нагрузке, `260 Мбайт` — по максимальной.
### Оборудование
Средняя скорость интернта в России 22,82 Мбит/c (входящая), 10 Мбит/с (исходящая) для мобильных сетей и 78,07 Мбит/с (входящая), 82.26 Мбит/с (исходящая) для Wi-fi [\[13\]][13].

Посчитаем максимальный объём входящего и исходящего трафика на один звонок.  
Входящий: `485,14 Гбайт/c / 16 817 = 29,54 Мбайт/c = 236,32 Мбит/с`; в расчёте на одного пользователя: `(479,5 Гбайт/с / 5 + 4,09 Гбайт/с / 4 + 1,55 Гбайт/с / 40) / 16 817 = 5,9 Мбайт/с = 47,23 Мбит/с.`  
Исходящий: `3781,45 Гбайт/с / 16 817 = 230 Мбайт/с = 1842 Мбит/с`; в расчёте на одного пользователя: `(3740 Гбайт/с / 39 + 39,9 Гбайт/с / 39 + 1,55 / 40) / 16 817 = 5,9 Мбайт/с = 47,23 Мбит/с`.

Подводя итог, на каждый звонок нужно иметь 120 потоков, 260 Мбайт оперативной памяти. По максимальному количеству звонков — 1 866 687 потоков, 4263,5 Гбайт оперативной памяти.   Получается по 1 серверу с СУБД для каждого дата-центра: тут хватит одного любого серверного процессора, минимального объёма оперативной памяти и жёсткого диска; скажем, 6 Гбайт и 20-30 Гбайт. Примерно 155 CPU по 100 потоков каждый, 48 Гбайт оперативной памяти на каждые 120 потоков, 30 Гбайт жёсткий диск на каждый сервер.
## Выбор хостинга / облачного провайдера и расположения серверов
Mail Cloud Solutions. Основыные преимущества: единственный сервис, обещающий 1 Гбит/c исходящее соединение, дата-центры расположены в России. Остальные очевидны: репутация компанин, гибкость конфигураций. Единственный потенциальный минус: используемые процессоры обрабатывают только 161 кадр в секунду при кодировке видео в H.624 [\[14\]][benchmark]. Нo, думаю, это решается запуском нужного количества потоков.

Расположить сервера желательно максимально в соответствии с плотностью населения.
## Схема балансировки нагрузки
### Входящий трафик
Geo based DNS / Anycast.
### Внутрипроектный трафик
На входе в каждый региональный дата-центр используем virtual server via direct routing.

Если несколько перекодировщиков запущены на отдельном сервере, балансируем между ними нагрузку по round-robin.
## Обеспечение отказоустойчивости
- понижение качества для видео
- понижение fps для демонстрации экрана
- ограничение количества участников звонка
- резервные сервера для пиковой нагрузки (потому что понижение качества увеличит нагрузку на процессор и память)

[1]: http://highscalability.com/blog/2015/12/30/how-to-choose-an-in-memory-nosql-solution-performance-measur.html
[2]: https://habr.com/ru/company/mailru/blog/352760/
[3]: https://tristan91.tistory.com/320
[4]: https://medium.com/@denisanikin/tarantool-vinyl-200k-transactions-per-second-on-a-disk-based-database-c5f3cbba6543
[5]: https://www.tarantool.io/ru/doc/latest/book/box/engines/#storing-data-with-vinyl
[6]: https://opus-codec.org/comparison/
[7]: https://habr.com/ru/post/94394/
[8]: https://medium.com/@brandonaaskov/vp8-vs-h-264-originally-written-posted-on-may-19-2014-3b432d58abaa
[9]: https://toolstud.io/video/bitrate.php
[10]: https://rutd-ksk.com/kak-uznat-razreshenie-veb-kamery/#:~:text=%D0%A0%D0%B0%D0%B7%D1%80%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%B2%D0%B5%D0%B1%2D%D0%BA%D0%B0%D0%BC%D0%B5%D1%80%D1%8B%20%D0%BC%D0%BE%D0%B6%D0%B5%D1%82%20%D0%B2%D0%B0%D1%80%D1%8C%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D1%82%D1%8C%D1%81%D1%8F,%D0%B2%D0%B8%D0%B4%D0%B5%D0%BE%D0%BA%D0%BE%D0%BD%D1%84%D0%B5%D1%80%D0%B5%D0%BD%D1%86%D0%B8%D0%B9%20%D0%B8%20%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D0%B8%20%D0%BD%D0%B5%D0%B1%D0%BE%D0%BB%D1%8C%D1%88%D0%B8%D1%85%20%D0%B2%D0%B8%D0%B4%D0%B5%D0%BE%D1%80%D0%BE%D0%BB%D0%B8%D0%BA%D0%BE%D0%B2.
[11]: https://opus-codec.org/static/comparison/quality.svg
[12]: https://blogs.gnome.org/rbultje/2015/09/28/vp9-encodingdecoding-performance-vs-hevch-264/
[13]: https://www.speedtest.net/global-index/russia
[benchmark]: https://openbenchmarking.org/test/pts/x264
